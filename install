#!/bin/bash
# Super Claude Kit Installation Script
# Works both locally (for testing) and remotely (curl | bash)
# Author: Arpit Nath

set -eo pipefail

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸš€ Super Claude Kit Installation"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

GITHUB_REPO="arpitnath/super-claude-kit"

# Auto-detect latest version from GitHub API if not specified
if [ -z "${VERSION:-}" ]; then
  echo "ğŸ” Detecting latest version..."
  VERSION=$(curl -fsSL "https://api.github.com/repos/$GITHUB_REPO/releases/latest" 2>/dev/null | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/' || echo "")

  # Fallback to tags API if releases API fails
  if [ -z "$VERSION" ]; then
    VERSION=$(curl -fsSL "https://api.github.com/repos/$GITHUB_REPO/tags" 2>/dev/null | grep '"name"' | head -1 | sed -E 's/.*"([^"]+)".*/\1/' || echo "")
  fi

  # Final fallback
  if [ -z "$VERSION" ]; then
    VERSION="v1.1.2"
    echo "âš ï¸  Could not auto-detect version, using fallback: $VERSION"
  else
    echo "âœ“ Detected latest version: $VERSION"
  fi
fi

GITHUB_RAW="https://raw.githubusercontent.com/$GITHUB_REPO/$VERSION"

INSTALL_DIR="$(pwd)"

set +u
if [ -n "${BASH_SOURCE[0]:-}" ]; then
  SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
else
  SCRIPT_DIR=""
fi
set -u

INSTALL_MODE="remote"
if [ -n "$SCRIPT_DIR" ] && [ -f "$SCRIPT_DIR/manifest.json" ] && [ -d "$SCRIPT_DIR/hooks" ]; then
  INSTALL_MODE="local"
  echo "ğŸ“¦ Local installation mode detected"
  echo ""
else
  echo "ğŸŒ Remote installation mode (downloading from GitHub)"
  echo "ğŸ“Œ Installing version: $VERSION"
  echo ""
fi

echo ""

if [ ! -d "$INSTALL_DIR/.git" ]; then
  echo "â„¹ï¸  Git repository not detected"
  echo "   Super Claude Kit will use file-based change tracking"
  echo "   (Git provides additional context but is not required)"
  echo ""
fi

echo "Creating .claude directories..."
mkdir -p "$INSTALL_DIR/.claude/hooks"
mkdir -p "$INSTALL_DIR/.claude/agents"
mkdir -p "$INSTALL_DIR/.claude/skills"
mkdir -p "$INSTALL_DIR/.claude/scripts"
mkdir -p "$INSTALL_DIR/.claude/docs"
mkdir -p "$INSTALL_DIR/.claude/lib"
mkdir -p "$INSTALL_DIR/.claude/tools"
echo "âœ“ Directories created"
echo ""

echo "Loading manifest..."
if [ "$INSTALL_MODE" = "local" ]; then
  MANIFEST=$(cat "$SCRIPT_DIR/manifest.json")
else
  MANIFEST=$(curl -fsSL "$GITHUB_RAW/manifest.json")
fi
echo "âœ“ Manifest loaded"
echo ""

install_file() {
  local source_path=$1
  local dest_path=$2

  if [ "$INSTALL_MODE" = "local" ]; then
    cp "$SCRIPT_DIR/$source_path" "$INSTALL_DIR/$dest_path"
  else
    curl -fsSL "$GITHUB_RAW/$source_path" -o "$INSTALL_DIR/$dest_path"
  fi
}

echo "Installing hooks..."
HOOK_COUNT=0
for hook in $(echo "$MANIFEST" | python3 -c "import sys, json; [print(h) for h in json.load(sys.stdin)['components']['hooks']]"); do
  install_file "hooks/$hook" ".claude/hooks/$hook"
  chmod +x ".claude/hooks/$hook"
  HOOK_COUNT=$((HOOK_COUNT + 1))
done
echo "âœ“ Installed $HOOK_COUNT hooks"
echo ""

echo "Installing library files..."
LIB_COUNT=0
for lib_file in $(echo "$MANIFEST" | python3 -c "import sys, json; [print(l) for l in json.load(sys.stdin)['components'].get('lib', [])]" 2>/dev/null || echo ""); do
  if [ -n "$lib_file" ]; then
    install_file "lib/$lib_file" ".claude/lib/$lib_file"
    chmod +x ".claude/lib/$lib_file"
    LIB_COUNT=$((LIB_COUNT + 1))
  fi
done
if [ "$LIB_COUNT" -gt 0 ]; then
  echo "âœ“ Installed $LIB_COUNT library files"
else
  echo "âœ“ No library files to install"
fi
echo ""

echo "Installing utility scripts..."
SCRIPT_COUNT=0
for script in $(echo "$MANIFEST" | python3 -c "import sys, json; [print(s) for s in json.load(sys.stdin)['components']['scripts']]"); do
  install_file "scripts/$script" ".claude/scripts/$script"
  chmod +x ".claude/scripts/$script"
  SCRIPT_COUNT=$((SCRIPT_COUNT + 1))
done
echo "âœ“ Installed $SCRIPT_COUNT utility scripts"
echo ""

echo "Installing dependency tools..."
TOOL_COUNT=0
for tool in $(echo "$MANIFEST" | python3 -c "import sys, json; [print(t) for t in json.load(sys.stdin)['components'].get('tools', [])]" 2>/dev/null || echo ""); do
  if [ -n "$tool" ]; then
    mkdir -p "$INSTALL_DIR/.claude/tools/$tool"

    if [ "$INSTALL_MODE" = "local" ]; then
      cp -r "$SCRIPT_DIR/tools/$tool/"* "$INSTALL_DIR/.claude/tools/$tool/"
    else
      curl -fsSL "$GITHUB_RAW/tools/$tool/tool.json" -o "$INSTALL_DIR/.claude/tools/$tool/tool.json"

      ENTRY=$(cat "$INSTALL_DIR/.claude/tools/$tool/tool.json" | python3 -c "import sys, json; print(json.load(sys.stdin).get('entry', ''))" 2>/dev/null || echo "")
      if [ -n "$ENTRY" ]; then
        curl -fsSL "$GITHUB_RAW/tools/$tool/$ENTRY" -o "$INSTALL_DIR/.claude/tools/$tool/$ENTRY"
        chmod +x "$INSTALL_DIR/.claude/tools/$tool/$ENTRY"
      fi
    fi

    TOOL_COUNT=$((TOOL_COUNT + 1))
  fi
done
if [ "$TOOL_COUNT" -gt 0 ]; then
  echo "âœ“ Installed $TOOL_COUNT dependency tools"
else
  echo "âœ“ No tools to install (will be added in updates)"
fi
echo ""

echo "Installing skills..."
SKILL_COUNT=0
for skill in $(echo "$MANIFEST" | python3 -c "import sys, json; [print(s) for s in json.load(sys.stdin)['components']['skills']]"); do
  mkdir -p "$INSTALL_DIR/.claude/skills/$skill"
  install_file "skills/$skill/SKILL.md" ".claude/skills/$skill/SKILL.md"
  SKILL_COUNT=$((SKILL_COUNT + 1))
done
echo "âœ“ Installed $SKILL_COUNT skills"
echo ""

echo "Installing sub-agents..."
AGENT_COUNT=0
for agent in $(echo "$MANIFEST" | python3 -c "import sys, json; [print(a) for a in json.load(sys.stdin)['components']['agents']]"); do
  install_file "agents/$agent" ".claude/agents/$agent"
  AGENT_COUNT=$((AGENT_COUNT + 1))
done
echo "âœ“ Installed $AGENT_COUNT sub-agents"
echo ""

echo "Installing documentation..."
for doc in $(echo "$MANIFEST" | python3 -c "import sys, json; [print(d) for d in json.load(sys.stdin)['components']['docs']]"); do
  install_file "docs/$doc" ".claude/docs/$doc"
done
echo "âœ“ Documentation installed"
echo ""

echo "Building dependency tools locally..."
mkdir -p "$HOME/.claude/bin"

# Check if Go is installed, or install it locally
GO_CMD="go"
if ! command -v go &> /dev/null; then
  echo "ğŸ“¥ Go not found. Installing Go locally to ~/.claude/go..."

  # Detect platform
  ARCH=$(uname -m)
  OS=$(uname -s | tr '[:upper:]' '[:lower:]')

  case "$ARCH" in
    x86_64) ARCH="amd64" ;;
    arm64|aarch64) ARCH="arm64" ;;
  esac

  case "$OS" in
    darwin) OS="darwin" ;;
    linux) OS="linux" ;;
  esac

  GO_VERSION="1.23.4"
  GO_URL="https://go.dev/dl/go${GO_VERSION}.${OS}-${ARCH}.tar.gz"

  echo "  Downloading Go ${GO_VERSION} for ${OS}-${ARCH}..."
  if curl -fsSL "$GO_URL" | tar -xz -C "$HOME/.claude/" 2>&1 | grep -v "^x "; then
    echo "  âœ… Go installed to ~/.claude/go"
    GO_CMD="$HOME/.claude/go/bin/go"
    echo ""
  else
    echo "  âŒ Failed to download Go"
    echo "  The kit will still work, but dependency tools will not be available."
    echo "  You can install Go manually from https://go.dev/dl/"
    echo ""
    GO_CMD=""
  fi
else
  GO_VERSION=$(go version | awk '{print $3}')
  echo "âœ“ Found Go: $GO_VERSION"
  echo ""
fi

if [ -n "$GO_CMD" ]; then

  BUILT_TOOLS=0

  # For remote mode, clone source to temp directory for building
  BUILD_DIR="$SCRIPT_DIR"
  TEMP_BUILD_DIR=""

  if [ "$INSTALL_MODE" = "remote" ]; then
    echo "  Downloading source code for building..."
    TEMP_BUILD_DIR=$(mktemp -d)

    if git clone --quiet --depth 1 --branch "$VERSION" "https://github.com/$GITHUB_REPO.git" "$TEMP_BUILD_DIR" 2>&1 | grep -v "^Cloning"; then
      BUILD_DIR="$TEMP_BUILD_DIR"
      echo "  âœ… Source code downloaded"
    else
      echo "  âŒ Failed to download source code"
      BUILD_DIR=""
    fi
  fi

  # Build dependency-scanner
  if [ -n "$BUILD_DIR" ] && [ -d "$BUILD_DIR/tools/dependency-scanner" ]; then
    echo "  Building dependency-scanner..."
    if (cd "$BUILD_DIR/tools/dependency-scanner" && "$GO_CMD" build -o "$HOME/.claude/bin/dependency-scanner" . >/dev/null 2>&1); then
      chmod +x "$HOME/.claude/bin/dependency-scanner"
      SCANNER_VERSION=$("$HOME/.claude/bin/dependency-scanner" --version 2>&1 | head -1 || echo "unknown")
      echo "  âœ… dependency-scanner built: $SCANNER_VERSION"
      BUILT_TOOLS=$((BUILT_TOOLS + 1))
    else
      echo "  âŒ Failed to build dependency-scanner"
    fi
  fi

  # Build progressive-reader
  if [ -n "$BUILD_DIR" ] && [ -d "$BUILD_DIR/tools/progressive-reader" ]; then
    echo "  Building progressive-reader..."
    if (cd "$BUILD_DIR/tools/progressive-reader" && "$GO_CMD" build -o "$HOME/.claude/bin/progressive-reader" cmd/main.go >/dev/null 2>&1); then
      chmod +x "$HOME/.claude/bin/progressive-reader"
      READER_VERSION=$("$HOME/.claude/bin/progressive-reader" --version 2>&1 | head -1 || echo "unknown")
      echo "  âœ… progressive-reader built: $READER_VERSION"
      BUILT_TOOLS=$((BUILT_TOOLS + 1))
    else
      echo "  âŒ Failed to build progressive-reader"
    fi
  fi

  # Clean up temp directory
  if [ -n "$TEMP_BUILD_DIR" ] && [ -d "$TEMP_BUILD_DIR" ]; then
    rm -rf "$TEMP_BUILD_DIR"
  fi

  echo ""
  if [ "$BUILT_TOOLS" -eq 2 ]; then
    echo "âœ“ All dependency tools built successfully"
  elif [ "$BUILT_TOOLS" -gt 0 ]; then
    echo "âš ï¸  Some tools built successfully ($BUILT_TOOLS/2)"
  else
    echo "âŒ Failed to build dependency tools"
  fi
fi
echo ""

echo "Configuring Claude Code..."
if [ ! -f "$INSTALL_DIR/.claude/settings.local.json" ]; then
  cat > "$INSTALL_DIR/.claude/settings.local.json" << 'EOF'
{
  "hooks": {
    "SessionStart": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "bash .claude/hooks/session-start.sh"
          }
        ]
      }
    ],
    "UserPromptSubmit": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "bash .claude/hooks/pre-task-analysis.sh"
          }
        ]
      }
    ],
    "PostToolUse": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "bash .claude/hooks/post-tool-use.sh"
          }
        ]
      }
    ],
    "PreToolUse": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "bash .claude/hooks/pre-tool-use.sh"
          }
        ]
      }
    ],
    "Stop": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "bash .claude/hooks/stop.sh"
          }
        ]
      }
    ],
    "SessionEnd": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "bash .claude/hooks/session-end.sh"
          }
        ]
      }
    ]
  }
}
EOF
  echo "âœ“ Created settings.local.json"
else
  echo "âœ“ settings.local.json exists, merging hooks..."

  python3 << 'PYTHON_MERGE'
import json
import sys

with open('.claude/settings.local.json', 'r') as f:
    existing = json.load(f)

def make_hook_cmd(hook_file):
    return f'bash -c \'DIR=$PWD; while [ "$DIR" != "/" ]; do [ -d "$DIR/.claude" ] && cd "$DIR" && exec bash .claude/hooks/{hook_file}; DIR=$(dirname "$DIR"); done\''

required_hooks = {
    "SessionStart": [{
        "matcher": "*",
        "hooks": [{"type": "command", "command": make_hook_cmd("session-start.sh")}]
    }],
    "UserPromptSubmit": [{
        "matcher": "*",
        "hooks": [{"type": "command", "command": make_hook_cmd("pre-task-analysis.sh")}]
    }],
    "PostToolUse": [{
        "matcher": "*",
        "hooks": [{"type": "command", "command": make_hook_cmd("post-tool-use.sh")}]
    }],
    "PreToolUse": [{
        "matcher": "*",
        "hooks": [{"type": "command", "command": make_hook_cmd("pre-tool-use.sh")}]
    }],
    "Stop": [{
        "matcher": "*",
        "hooks": [{"type": "command", "command": make_hook_cmd("stop.sh")}]
    }],
    "SessionEnd": [{
        "matcher": "*",
        "hooks": [{"type": "command", "command": make_hook_cmd("session-end.sh")}]
    }]
}

if 'hooks' not in existing:
    existing['hooks'] = {}

merged = False
for hook_name, hook_config in required_hooks.items():
    if hook_name not in existing['hooks']:
        existing['hooks'][hook_name] = hook_config
        merged = True
        print(f"  + Added {hook_name} hook")

with open('.claude/settings.local.json', 'w') as f:
    json.dump(existing, f, indent=2)

if merged:
    print("  âœ“ Hooks merged successfully")
else:
    print("  âœ“ All hooks already configured")
PYTHON_MERGE
fi
echo ""

echo "Updating .gitignore..."
if [ -f "$INSTALL_DIR/.gitignore" ]; then
  if ! grep -q "Super Claude Kit" "$INSTALL_DIR/.gitignore" 2>/dev/null; then
    echo "" >> "$INSTALL_DIR/.gitignore"
    echo "$MANIFEST" | python3 -c "import sys, json; [print(e) for e in json.load(sys.stdin)['gitignore_entries']]" >> "$INSTALL_DIR/.gitignore"
    echo "âœ“ Added Super Claude Kit entries to .gitignore"
  else
    echo "âœ“ .gitignore already contains Super Claude Kit entries"
  fi
else
  echo "$MANIFEST" | python3 -c "import sys, json; [print(e) for e in json.load(sys.stdin)['gitignore_entries']]" > "$INSTALL_DIR/.gitignore"
  echo "âœ“ Created .gitignore with Super Claude Kit entries"
fi
echo ""

echo "Updating project instructions..."
if [ -f "$INSTALL_DIR/CLAUDE.md" ]; then
  if ! grep -q "Super Claude Kit Integration" "$INSTALL_DIR/CLAUDE.md" 2>/dev/null; then
    echo "" >> "$INSTALL_DIR/CLAUDE.md"
    echo "---" >> "$INSTALL_DIR/CLAUDE.md"
    echo "" >> "$INSTALL_DIR/CLAUDE.md"
    install_file "CLAUDE_TEMPLATE.md" ".claude/CLAUDE_TEMPLATE.tmp"
    cat "$INSTALL_DIR/.claude/CLAUDE_TEMPLATE.tmp" >> "$INSTALL_DIR/CLAUDE.md"
    rm "$INSTALL_DIR/.claude/CLAUDE_TEMPLATE.tmp"
    echo "âœ“ Added Super Claude Kit section to CLAUDE.md"
  else
    echo "âœ“ CLAUDE.md already has Super Claude Kit integration"
  fi
else
  install_file "CLAUDE_TEMPLATE.md" "CLAUDE.md"
  echo "âœ“ Created CLAUDE.md with Super Claude Kit instructions"
fi
echo ""

echo "Initializing capsule system..."
cd "$INSTALL_DIR"
bash .claude/hooks/init-capsule-session.sh >/dev/null 2>&1 || true
bash .claude/hooks/update-capsule.sh >/dev/null 2>&1 || true

if [ -f "$INSTALL_DIR/.claude/capsule.toon" ]; then
  echo "âœ“ Capsule initialized successfully"
else
  echo "âš ï¸  Capsule initialization skipped (may need git repository)"
fi
echo ""

echo "Saving version information..."
MANIFEST_VERSION=$(echo "$MANIFEST" | python3 -c "import sys, json; print(json.load(sys.stdin)['version'])")
echo "$MANIFEST_VERSION" > "$INSTALL_DIR/.claude/.super-claude-version"
date +%s > "$INSTALL_DIR/.claude/.super-claude-installed"
echo "âœ“ Version $MANIFEST_VERSION tracked"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Super Claude Kit Installed Successfully!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“Š Installed components:"
echo "   â€¢ $HOOK_COUNT hooks"
echo "   â€¢ $SCRIPT_COUNT utility scripts"
if [ "$TOOL_COUNT" -gt 0 ]; then
  echo "   â€¢ $TOOL_COUNT dependency tools"
fi
echo "   â€¢ $SKILL_COUNT skills"
echo "   â€¢ $AGENT_COUNT sub-agents"
if [ -f "$HOME/.claude/bin/dependency-scanner" ] && [ -f "$HOME/.claude/bin/progressive-reader" ]; then
  echo "   â€¢ Built tools: dependency-scanner, progressive-reader"
elif [ -f "$HOME/.claude/bin/dependency-scanner" ] || [ -f "$HOME/.claude/bin/progressive-reader" ]; then
  echo "   â€¢ Some built tools (Go tools partially built)"
fi
echo "   â€¢ Documentation & templates"
echo ""
echo "ğŸš€ Next steps:"
echo "   1. Run tests: bash .claude/scripts/test-super-claude.sh"
echo "   2. Start Claude Code in this directory"
echo "   3. Look for: 'ğŸš€ Super Claude Kit ACTIVATED'"
if [ -f "$HOME/.claude/bin/dependency-scanner" ]; then
  echo "   4. Try dependency tools: .claude/tools/find-circular.sh"
fi
echo ""
echo "ğŸ“– Documentation:"
echo "   â€¢ Usage guide: .claude/docs/CAPSULE_USAGE_GUIDE.md"
echo "   â€¢ Project instructions: CLAUDE.md"
echo "   â€¢ View stats: bash .claude/scripts/show-stats.sh"
if [ -f "$HOME/.claude/bin/dependency-scanner" ]; then
  echo "   â€¢ Dependency tools: .claude/tools/"
fi
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
