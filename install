#!/bin/bash
# Super Claude Kit Installation Script
# Works both locally (for testing) and remotely (curl | bash)
# Author: Arpit Nath

set -eo pipefail

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸš€ Super Claude Kit Installation"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Configuration
GITHUB_REPO="arpitnath/super-claude-kit"
GITHUB_BRANCH="master"
GITHUB_RAW="https://raw.githubusercontent.com/$GITHUB_REPO/$GITHUB_BRANCH"

# Save current directory (where user wants to install)
INSTALL_DIR="$(pwd)"

# Get script directory (handle both local execution and piped curl)
# Temporarily disable -u flag to check BASH_SOURCE safely
set +u
if [ -n "${BASH_SOURCE[0]:-}" ]; then
  SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
else
  # Piped from curl, no source file
  SCRIPT_DIR=""
fi
set -u

# Detect installation mode
INSTALL_MODE="remote"
if [ -n "$SCRIPT_DIR" ] && [ -f "$SCRIPT_DIR/manifest.json" ] && [ -d "$SCRIPT_DIR/hooks" ]; then
  INSTALL_MODE="local"
  echo "ğŸ“¦ Local installation mode detected"
else
  echo "ğŸŒ Remote installation mode (downloading from GitHub)"
fi

echo ""

# Check if we're in a git repository (recommended)
if [ ! -d "$INSTALL_DIR/.git" ]; then
  echo "âš ï¸  Warning: Not in a git repository"
  echo "   Super Claude Kit works best in git repositories"
  echo ""
  read -p "Continue anyway? (y/n) " -n 1 -r
  echo ""
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
  echo ""
fi

# Create directories
echo "Creating .claude directories..."
mkdir -p "$INSTALL_DIR/.claude/hooks"
mkdir -p "$INSTALL_DIR/.claude/agents"
mkdir -p "$INSTALL_DIR/.claude/skills"
mkdir -p "$INSTALL_DIR/.claude/scripts"
mkdir -p "$INSTALL_DIR/.claude/docs"
mkdir -p "$INSTALL_DIR/.claude/lib"
mkdir -p "$INSTALL_DIR/.claude/tools"
echo "âœ“ Directories created"
echo ""

# Download or copy manifest
echo "Loading manifest..."
if [ "$INSTALL_MODE" = "local" ]; then
  MANIFEST=$(cat "$SCRIPT_DIR/manifest.json")
else
  MANIFEST=$(curl -fsSL "$GITHUB_RAW/manifest.json")
fi
echo "âœ“ Manifest loaded"
echo ""

# Helper function to download or copy file
install_file() {
  local source_path=$1
  local dest_path=$2

  if [ "$INSTALL_MODE" = "local" ]; then
    cp "$SCRIPT_DIR/$source_path" "$INSTALL_DIR/$dest_path"
  else
    curl -fsSL "$GITHUB_RAW/$source_path" -o "$INSTALL_DIR/$dest_path"
  fi
}

# Install hooks
echo "Installing hooks..."
HOOK_COUNT=0
for hook in $(echo "$MANIFEST" | python3 -c "import sys, json; [print(h) for h in json.load(sys.stdin)['components']['hooks']]"); do
  install_file "hooks/$hook" ".claude/hooks/$hook"
  chmod +x ".claude/hooks/$hook"
  HOOK_COUNT=$((HOOK_COUNT + 1))
done
echo "âœ“ Installed $HOOK_COUNT hooks"
echo ""

# Install lib files
echo "Installing library files..."
LIB_COUNT=0
for lib_file in $(echo "$MANIFEST" | python3 -c "import sys, json; [print(l) for l in json.load(sys.stdin)['components'].get('lib', [])]" 2>/dev/null || echo ""); do
  if [ -n "$lib_file" ]; then
    install_file "lib/$lib_file" ".claude/lib/$lib_file"
    chmod +x ".claude/lib/$lib_file"
    LIB_COUNT=$((LIB_COUNT + 1))
  fi
done
if [ "$LIB_COUNT" -gt 0 ]; then
  echo "âœ“ Installed $LIB_COUNT library files"
else
  echo "âœ“ No library files to install"
fi
echo ""

# Install scripts
echo "Installing utility scripts..."
SCRIPT_COUNT=0
for script in $(echo "$MANIFEST" | python3 -c "import sys, json; [print(s) for s in json.load(sys.stdin)['components']['scripts']]"); do
  install_file "scripts/$script" ".claude/scripts/$script"
  chmod +x ".claude/scripts/$script"
  SCRIPT_COUNT=$((SCRIPT_COUNT + 1))
done
echo "âœ“ Installed $SCRIPT_COUNT utility scripts"
echo ""

# Install tools (v2.0+)
echo "Installing dependency tools..."
TOOL_COUNT=0
for tool in $(echo "$MANIFEST" | python3 -c "import sys, json; [print(t) for t in json.load(sys.stdin)['components'].get('tools', [])]" 2>/dev/null || echo ""); do
  if [ -n "$tool" ]; then
    mkdir -p "$INSTALL_DIR/.claude/tools/$tool"

    # Copy entire tool directory
    if [ "$INSTALL_MODE" = "local" ]; then
      cp -r "$SCRIPT_DIR/tools/$tool/"* "$INSTALL_DIR/.claude/tools/$tool/"
    else
      # For remote installation, download tool.json and the main script
      curl -fsSL "$GITHUB_RAW/tools/$tool/tool.json" -o "$INSTALL_DIR/.claude/tools/$tool/tool.json"

      # Get entry point from tool.json
      ENTRY=$(cat "$INSTALL_DIR/.claude/tools/$tool/tool.json" | python3 -c "import sys, json; print(json.load(sys.stdin).get('entry', ''))" 2>/dev/null || echo "")
      if [ -n "$ENTRY" ]; then
        curl -fsSL "$GITHUB_RAW/tools/$tool/$ENTRY" -o "$INSTALL_DIR/.claude/tools/$tool/$ENTRY"
        chmod +x "$INSTALL_DIR/.claude/tools/$tool/$ENTRY"
      fi
    fi

    TOOL_COUNT=$((TOOL_COUNT + 1))
  fi
done
if [ "$TOOL_COUNT" -gt 0 ]; then
  echo "âœ“ Installed $TOOL_COUNT dependency tools"
else
  echo "âœ“ No tools to install (will be added in updates)"
fi
echo ""

# Install skills
echo "Installing skills..."
SKILL_COUNT=0
for skill in $(echo "$MANIFEST" | python3 -c "import sys, json; [print(s) for s in json.load(sys.stdin)['components']['skills']]"); do
  mkdir -p "$INSTALL_DIR/.claude/skills/$skill"
  install_file "skills/$skill/SKILL.md" ".claude/skills/$skill/SKILL.md"
  SKILL_COUNT=$((SKILL_COUNT + 1))
done
echo "âœ“ Installed $SKILL_COUNT skills"
echo ""

# Install agents
echo "Installing sub-agents..."
AGENT_COUNT=0
for agent in $(echo "$MANIFEST" | python3 -c "import sys, json; [print(a) for a in json.load(sys.stdin)['components']['agents']]"); do
  install_file "agents/$agent" ".claude/agents/$agent"
  AGENT_COUNT=$((AGENT_COUNT + 1))
done
echo "âœ“ Installed $AGENT_COUNT sub-agents"
echo ""

# Install documentation
echo "Installing documentation..."
for doc in $(echo "$MANIFEST" | python3 -c "import sys, json; [print(d) for d in json.load(sys.stdin)['components']['docs']]"); do
  install_file "docs/$doc" ".claude/docs/$doc"
done
echo "âœ“ Documentation installed"
echo ""

# Install dependency scanner binary (v2.0+)
echo "Installing dependency scanner binary..."
mkdir -p "$HOME/.claude/bin"

# Detect platform
ARCH=$(uname -m)
OS=$(uname -s | tr '[:upper:]' '[:lower:]')

# Map architecture
case "$ARCH" in
  x86_64) ARCH="amd64" ;;
  arm64|aarch64) ARCH="arm64" ;;
esac

# Map OS
case "$OS" in
  darwin) OS="darwin" ;;
  linux) OS="linux" ;;
  *) OS="unknown" ;;
esac

BINARY_NAME="dependency-scanner-${OS}-${ARCH}"

if [ "$INSTALL_MODE" = "local" ] && [ -f "$SCRIPT_DIR/tools/dependency-scanner/bin/$BINARY_NAME" ]; then
  # Local installation: copy binary
  cp "$SCRIPT_DIR/tools/dependency-scanner/bin/$BINARY_NAME" "$HOME/.claude/bin/dependency-scanner"
  chmod +x "$HOME/.claude/bin/dependency-scanner"
  echo "âœ“ Dependency scanner installed (local)"
elif [ "$OS" != "unknown" ]; then
  # Remote installation: download from GitHub releases
  BINARY_URL="https://github.com/arpitnath/super-claude-kit/releases/download/v2.0.0/${BINARY_NAME}"

  if curl -fsSL "$BINARY_URL" -o "$HOME/.claude/bin/dependency-scanner" 2>/dev/null; then
    chmod +x "$HOME/.claude/bin/dependency-scanner"
    echo "âœ“ Dependency scanner installed"
  else
    echo "âš ï¸  Could not download dependency scanner (will be available in v2.0 release)"
    echo "   Scanner functionality will be skipped until available"
  fi
else
  echo "âš ï¸  Unsupported platform: $OS-$ARCH"
  echo "   Dependency scanner will not be installed"
fi
echo ""

# Create or update settings.local.json
echo "Configuring Claude Code..."
if [ ! -f "$INSTALL_DIR/.claude/settings.local.json" ]; then
  cat > "$INSTALL_DIR/.claude/settings.local.json" << 'EOF'
{
  "hooks": {
    "SessionStart": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "bash .claude/hooks/session-start.sh"
          }
        ]
      }
    ],
    "UserPromptSubmit": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "bash .claude/hooks/pre-task-analysis.sh"
          }
        ]
      }
    ],
    "PostToolUse": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "bash .claude/hooks/post-tool-use.sh"
          }
        ]
      }
    ],
    "PreToolUse": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "bash .claude/hooks/pre-tool-use.sh"
          }
        ]
      }
    ],
    "Stop": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "bash .claude/hooks/stop.sh"
          }
        ]
      }
    ],
    "SessionEnd": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "bash .claude/hooks/session-end.sh"
          }
        ]
      }
    ]
  }
}
EOF
  echo "âœ“ Created settings.local.json"
else
  echo "âœ“ settings.local.json exists, merging hooks..."

  # Smart merge: Add missing hooks without overwriting existing settings
  python3 << 'PYTHON_MERGE'
import json
import sys

# Read existing settings
with open('.claude/settings.local.json', 'r') as f:
    existing = json.load(f)

# Define required hooks from v1.1.0
required_hooks = {
    "SessionStart": [{
        "matcher": "*",
        "hooks": [{"type": "command", "command": "bash .claude/hooks/session-start.sh"}]
    }],
    "UserPromptSubmit": [{
        "matcher": "*",
        "hooks": [{"type": "command", "command": "bash .claude/hooks/pre-task-analysis.sh"}]
    }],
    "PostToolUse": [{
        "matcher": "*",
        "hooks": [{"type": "command", "command": "bash .claude/hooks/post-tool-use.sh"}]
    }],
    "PreToolUse": [{
        "matcher": "*",
        "hooks": [{"type": "command", "command": "bash .claude/hooks/pre-tool-use.sh"}]
    }],
    "Stop": [{
        "matcher": "*",
        "hooks": [{"type": "command", "command": "bash .claude/hooks/stop.sh"}]
    }],
    "SessionEnd": [{
        "matcher": "*",
        "hooks": [{"type": "command", "command": "bash .claude/hooks/session-end.sh"}]
    }]
}

# Ensure hooks object exists
if 'hooks' not in existing:
    existing['hooks'] = {}

# Merge: Add missing hooks, preserve existing
merged = False
for hook_name, hook_config in required_hooks.items():
    if hook_name not in existing['hooks']:
        existing['hooks'][hook_name] = hook_config
        merged = True
        print(f"  + Added {hook_name} hook")

# Write back merged settings
with open('.claude/settings.local.json', 'w') as f:
    json.dump(existing, f, indent=2)

if merged:
    print("  âœ“ Hooks merged successfully")
else:
    print("  âœ“ All hooks already configured")
PYTHON_MERGE
fi
echo ""

# Update .gitignore
echo "Updating .gitignore..."
if [ -f "$INSTALL_DIR/.gitignore" ]; then
  if ! grep -q "Super Claude Kit" "$INSTALL_DIR/.gitignore" 2>/dev/null; then
    echo "" >> "$INSTALL_DIR/.gitignore"
    echo "$MANIFEST" | python3 -c "import sys, json; [print(e) for e in json.load(sys.stdin)['gitignore_entries']]" >> "$INSTALL_DIR/.gitignore"
    echo "âœ“ Added Super Claude Kit entries to .gitignore"
  else
    echo "âœ“ .gitignore already contains Super Claude Kit entries"
  fi
else
  echo "$MANIFEST" | python3 -c "import sys, json; [print(e) for e in json.load(sys.stdin)['gitignore_entries']]" > "$INSTALL_DIR/.gitignore"
  echo "âœ“ Created .gitignore with Super Claude Kit entries"
fi
echo ""

# Add Super Claude Kit section to CLAUDE.md
echo "Updating project instructions..."
if [ -f "$INSTALL_DIR/CLAUDE.md" ]; then
  if ! grep -q "Super Claude Kit Integration" "$INSTALL_DIR/CLAUDE.md" 2>/dev/null; then
    echo "" >> "$INSTALL_DIR/CLAUDE.md"
    echo "---" >> "$INSTALL_DIR/CLAUDE.md"
    echo "" >> "$INSTALL_DIR/CLAUDE.md"
    # Download template to .claude directory (not /tmp to avoid path issues)
    install_file "CLAUDE_TEMPLATE.md" ".claude/CLAUDE_TEMPLATE.tmp"
    cat "$INSTALL_DIR/.claude/CLAUDE_TEMPLATE.tmp" >> "$INSTALL_DIR/CLAUDE.md"
    rm "$INSTALL_DIR/.claude/CLAUDE_TEMPLATE.tmp"
    echo "âœ“ Added Super Claude Kit section to CLAUDE.md"
  else
    echo "âœ“ CLAUDE.md already has Super Claude Kit integration"
  fi
else
  install_file "CLAUDE_TEMPLATE.md" "CLAUDE.md"
  echo "âœ“ Created CLAUDE.md with Super Claude Kit instructions"
fi
echo ""

# Initialize capsule system
echo "Initializing capsule system..."
cd "$INSTALL_DIR"
bash .claude/hooks/init-capsule-session.sh >/dev/null 2>&1 || true
bash .claude/hooks/update-capsule.sh >/dev/null 2>&1 || true

if [ -f "$INSTALL_DIR/.claude/capsule.toon" ]; then
  echo "âœ“ Capsule initialized successfully"
else
  echo "âš ï¸  Capsule initialization skipped (may need git repository)"
fi
echo ""

# Save version and installation timestamp
echo "Saving version information..."
MANIFEST_VERSION=$(echo "$MANIFEST" | python3 -c "import sys, json; print(json.load(sys.stdin)['version'])")
echo "$MANIFEST_VERSION" > "$INSTALL_DIR/.claude/.super-claude-version"
date +%s > "$INSTALL_DIR/.claude/.super-claude-installed"
echo "âœ“ Version $MANIFEST_VERSION tracked"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Super Claude Kit Installed Successfully!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“Š Installed components:"
echo "   â€¢ $HOOK_COUNT hooks"
echo "   â€¢ $SCRIPT_COUNT utility scripts"
if [ "$TOOL_COUNT" -gt 0 ]; then
  echo "   â€¢ $TOOL_COUNT dependency tools"
fi
echo "   â€¢ $SKILL_COUNT skills"
echo "   â€¢ $AGENT_COUNT sub-agents"
if [ -f "$HOME/.claude/bin/dependency-scanner" ]; then
  echo "   â€¢ Dependency scanner binary"
fi
echo "   â€¢ Documentation & templates"
echo ""
echo "ğŸš€ Next steps:"
echo "   1. Run tests: bash .claude/scripts/test-super-claude.sh"
echo "   2. Start Claude Code in this directory"
echo "   3. Look for: 'ğŸš€ Super Claude Kit ACTIVATED'"
if [ -f "$HOME/.claude/bin/dependency-scanner" ]; then
  echo "   4. Try dependency tools: .claude/tools/find-circular.sh"
fi
echo ""
echo "ğŸ“– Documentation:"
echo "   â€¢ Usage guide: .claude/docs/CAPSULE_USAGE_GUIDE.md"
echo "   â€¢ Project instructions: CLAUDE.md"
echo "   â€¢ View stats: bash .claude/scripts/show-stats.sh"
if [ -f "$HOME/.claude/bin/dependency-scanner" ]; then
  echo "   â€¢ Dependency tools: .claude/tools/ (NEW in v2.0)"
fi
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
